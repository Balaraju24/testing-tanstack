import{r as c,h as fe,t as f,j as t,c as C}from"./main-Cfdx-166.js";import{U as H}from"./Provider-ByMBYsBJ.js";import{L as he}from"./Loading-CBYA94ZU.js";import{u as ge}from"./useUserPermissions-EkOdBJwI.js";import{i as ye,M as we}from"./ManageCaseHeader-C-iqY6N9.js";import{D as $}from"./delete-stroke-icon-Bw6hM1IS.js";import{f as je,u as be,b as Ne,h as ve}from"./fileUpload-C5Dy2rVy.js";import{u as De,f as Te}from"./legalOpinion-Br1-lBUF.js";import{T as b}from"./getCaseFilesConstants-BW7ghkNO.js";import{d as K}from"./stateConstants-CjBDojTL.js";import{d as Ee}from"./apiHelpers-Bpl3N5CG.js";import{u as N}from"./useMutation-B1DU5d2J.js";import{d as B}from"./dayjs.min-CmsQqqGy.js";import{P as Se}from"./pen-DPOfTKbd.js";import{C as M}from"./check-eR3old9D.js";import{F as ke}from"./file-text-C_yTirqY.js";import{X as Y}from"./x-OEbIHzu5.js";import{U as Ce}from"./upload-CgsScTzV.js";import{S as _e}from"./search-BG32cvb7.js";import{C as Ue}from"./chevron-down-CCzDJ7wY.js";import{P as Ie}from"./plus-CqTDA3jy.js";import{L as V}from"./loader-circle-CtVpcMqj.js";import{E as Fe}from"./eye-BQaVMbMk.js";import{D as Pe}from"./download-DD_AicsW.js";import"./litigations-CHZYp0Qz.js";import"./fetch-B9iWZIk4.js";import"./manage-N6m0a4Rv.js";import"./useQuery-JrEwn0HC.js";import"./useInfiniteQuery-CsBoIoE-.js";import"./index-FfAIZCaX.js";import"./index-CHQA3myx.js";import"./userDetails-BK07mqDr.js";import"./index-lXLfk88N.js";import"./CaseFilingIcon-B3T83UWb.js";import"./legal-notice-icon-CQRroJUz.js";import"./notes-edit-icon-DR2vjJ_2.js";import"./index-C_gXUdb4.js";import"./index-hzHaN75t.js";import"./index-DF_xtgj4.js";import"./tooltip-Dk48ikt-.js";import"./index-DE95MUWf.js";import"./index-BoybbV93.js";import"./index-BBlAPqfG.js";import"./manage-B5DlZb4f.js";import"./utc-BVtgXMZy.js";import"./pending-icon-DAWTPq6S.js";import"./approved-Icon-DeOvi-fV.js";import"./current-icon-8I7qxN0n.js";import"./complete-logo-C9qAcUgu.js";import"./notes-close-icon-DwQRAOm_.js";import"./index-DETgyAaU.js";import"./index-Vwln1SHO.js";import"./textarea-HR3ErcZs.js";import"./createLucideIcon-BmLFQ-XG.js";import"./notification-Dr26wPLe.js";import"./service-7i-FAUkJ.js";import"./index-BjReNNxi.js";import"./default-user-H6DJgCjJ.js";import"./notes-delete-icon-BGPvWUIE.js";import"./notes-head-icon-B7j4bc-E.js";import"./summary-icon-card-D2HQg2x6.js";import"./avatar-BO1wJRFV.js";import"./input-DYbhqlvz.js";import"./sheet-CMzcKqsy.js";import"./skeleton-CvqsTR7_.js";const ze=({subStage:v,editMode:m,setEditMode:x})=>{const p=c.useRef({}),D=e=>s=>{p.current[e]=s},{service_id:w}=fe({strict:!1}),[l,o]=c.useState([]),[_,T]=c.useState(""),[j,h]=c.useState({}),[E,u]=c.useState({}),[G,g]=c.useState({}),[X,U]=c.useState(null),[I,q]=c.useState(""),{getAllDocsRefetch:F,allDocsData:i,caseStagesData:J}=H(),P=ye(J?.sub_stages,v),S=e=>{const s=p.current[e];if(!s)return"bottom";const a=s.getBoundingClientRect(),r=window.innerHeight,n=176,d=r-a.bottom,y=a.top;return d<n&&y>n?"top":"bottom"};c.useEffect(()=>{const e=s=>{Object.keys(p.current).forEach(a=>{const r=p.current[parseInt(a)];r&&!r.contains(s.target)&&u(n=>({...n,[parseInt(a)]:!1}))})};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const{mutate:Q}=N({mutationFn:async({file:e,documentId:s})=>{const a=e.name.split(".").pop()||"unknown",{data:r}=await je({file_name:e.name,file_type:a,file_size:e.size}),{target_url:n,file_key:d}=r?.data;if(!n)throw new Error("Presigned URL is missing");const y=await be(n,e);if(y.status!==200&&y.status!==201)throw new Error(`S3 upload failed with status: ${y.status}`);return{file_name:e.name,file_type:a,file_size:e.size,key:d,documentId:s}},onSuccess:({key:e,documentId:s})=>{o(a=>a.map(r=>r.id===s?{...r,s3Key:e,uploading:!1,uploaded:!0,fileError:"",isUpdated:r.existingId?!0:r.isUpdated}:r))},onError:(e,{documentId:s})=>{o(a=>a.map(r=>r.id===s?{...r,file:null,s3Key:"",uploading:!1,uploaded:!1,fileError:e?.data?.errData?.file_size||"File upload failed. Please try again."}:r))}}),{mutateAsync:W}=N({mutationFn:async e=>await Ne({docId:e}),onSuccess:()=>{F()},onError:()=>{f.error("Failed to delete document.")}}),Z=()=>{o([{id:1,file:null,documentType:"",customType:"",s3Key:"",uploading:!1,uploaded:!1,fileError:"",documentTypeError:""}]),T(""),h({}),u({}),g({})},ee=e=>{if(e){const s=l.map((a,r)=>{const n=e.data.errData[`docs.${r}.file_name`]?.[0]||e.data.errData[`docs.${r}.file_type`]?.[0]||e.data.errData[`docs.${r}.key`]?.[0]||"",d=e.data.errData[`docs.${r}.document_type`]?.[0]||"";return q(e.data.errData.docs?.[0]),{...a,fileError:n,documentTypeError:d}});o(s)}},{mutate:te,isPending:z}=N({mutationFn:async e=>i?.length!==0?await De(e):await Te(e),onSuccess:()=>{Z(),x(!1),F()},onError:ee}),{mutate:se,isPending:re}=N({mutationFn:async e=>{const s={file_key:e.key},a=await ve(s),r=a?.data?.status,n=a?.data?.data?.download_url;if((r===200||r===201)&&n)Ee(n,e.file_name),U(null);else throw new Error("Invalid response or download URL")},onError:()=>{f.error("Failed to download attachment.")}});c.useEffect(()=>{if(i?.length&&!l.length){const e=i.map((s,a)=>({id:a+1,existingId:s.id,file:{name:s.file_name,size:`${(s.file_size/1024).toFixed(1)}KB`,date:s.created_at,rawSize:s.file_size},documentType:s.document_type,customType:s.document_type==="Other"?s.document_type:"",s3Key:s.key,uploading:!1,uploaded:!0,fileError:"",documentTypeError:"",isUpdated:!1}));o(e),T(i[0]?.remarks||"")}else l.length||o([{id:1,file:null,documentType:"",customType:"",s3Key:"",uploading:!1,uploaded:!1,fileError:"",documentTypeError:""}])},[i,m]);const A=async(e,s)=>{if(!s){o(a=>a.map(r=>r.id===e?{...r,file:null,s3Key:"",uploading:!1,uploaded:!1,fileError:"",isUpdated:r.existingId?!0:r.isUpdated}:r));return}o(a=>a.map(r=>r.id===e?{...r,file:{name:s.name,size:`${(s.size/1024).toFixed(1)}KB`,date:new Date().toLocaleDateString(),rawSize:s.size},uploading:!0,uploaded:!1,fileError:"",isUpdated:r.existingId?!0:r.isUpdated}:r)),Q({file:s,documentId:e})},ae=(e,s)=>{o(a=>a.map(r=>r.id===e?{...r,documentType:s,customType:s==="Other"?r.customType:"",documentTypeError:"",isUpdated:r.existingId?!0:r.isUpdated}:r)),s!=="Other"&&h(a=>({...a,[e]:s})),u(a=>({...a,[e]:!1}))},ne=(e,s)=>{o(a=>a.map(r=>r.id===e?{...r,customType:s,documentType:"Other",documentTypeError:"",isUpdated:r.existingId?!0:r.isUpdated}:r))},oe=(e,s)=>{h(n=>({...n,[e]:s})),u(n=>({...n,[e]:!0}));const a=S(e);g(n=>({...n,[e]:a}));const r=l.find(n=>n.id===e);r&&r.documentType!=="Other"&&s!==r.documentType&&o(n=>n.map(d=>d.id===e?{...d,documentType:"",customType:"",documentTypeError:"",isUpdated:d.existingId?!0:d.isUpdated}:d))},ie=e=>{const s=!E[e];if(s){const a=S(e);g(r=>({...r,[e]:a}))}u(a=>({...a,[e]:s}))},le=e=>{const s=S(e);g(a=>({...a,[e]:s})),u(a=>({...a,[e]:!0}))},L=e=>{const s=l.find(a=>a.id===e);s?.existingId&&f.promise(W(s.existingId),{loading:b.DELETE_LOADING,success:b.DELETE_SUCCESS,error:b.DELETE_ERROR,action:{label:b.CLOSE_LABEL,onClick:()=>f.dismiss()}}),o(a=>a.filter(r=>r.id!==e)),h(a=>{const r={...a};return delete r[e],r}),u(a=>{const r={...a};return delete r[e],r}),g(a=>{const r={...a};return delete r[e],r}),delete p.current[e]},ce=()=>{const e=Math.max(...l.map(s=>s.id),0)+1;o([...l,{id:e,file:null,documentType:"",customType:"",s3Key:"",uploading:!1,uploaded:!1,fileError:"",documentTypeError:""}])},de=async()=>{const e=l.map(s=>{const a=s.file,r=a?a.name.split(".").pop()||"unknown":"";return{...s.existingId&&{id:s.existingId},case_id:Number(w),file_type:r,file_name:a?a.name:"",file_size:a?a.rawSize:0,key:s.s3Key||"",document_type:s.customType||s.documentType||"",remarks:_}});te({docs:e})},me=e=>{e.key?(U(e.id),se({key:e.key,file_name:e.file?.name||"document"})):f.error("Document key not available for download")},pe=e=>{e?window.open(e,"_blank","noopener,noreferrer"):f.error("No download URL available")},O=e=>e?K.filter(s=>s.toLowerCase().includes(e.toLowerCase())):K,ue=e=>e.documentType&&e.documentType!=="Other"?e.documentType:e.documentType==="Other"?"Other":"",xe=e=>{o(s=>s.map(a=>a.id===e?{...a,documentType:"",customType:"",documentTypeError:"",isUpdated:a.existingId?!0:a.isUpdated}:a)),h(s=>({...s,[e]:""}))},R="w-full p-3 bg-gray-100 outline-none text-sm rounded-none border-none",k="block text-sm font-normal text-gray-700 mb-1";return t.jsx("div",{className:"w-full max-w-none flex flex-col border-none overflow-hidden",children:t.jsxs("div",{className:"w-full max-w-4xl mx-auto mt-2 bg-white",children:[i?.length>0&&!P&&!m&&t.jsx("div",{className:"flex justify-end ",children:t.jsxs("button",{onClick:()=>{x(!m)},className:"bg-gray-800 text-white text-xs hover:bg-gray-900 rounded-none p-2 flex items-center cursor-pointer",children:[t.jsx(Se,{className:"w-4 h-4 mr-2"}),"Edit Documents"]})}),m||i?.length===0?t.jsx("div",{className:"p-2",children:t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"max-h-[calc(100vh-258px)] bg-gray-50/80 p-2 2xl:p-3 overflow-y-auto",children:[t.jsx("div",{children:l.map(e=>t.jsxs("div",{className:"grid grid-cols-11 gap-2 2xl:gap-4 items-start mb-3",children:[t.jsxs("div",{className:"col-span-5 space-y-2",children:[t.jsx("label",{className:k,children:"Upload Document"}),t.jsxs("div",{className:"relative",children:[e.file?t.jsxs("div",{className:"flex items-center px-4 py-1 bg-gray-100 relative",children:[t.jsx("div",{className:"w-5 h-5 mr-3 flex-shrink-0",children:e.uploading?t.jsx("div",{className:"w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}):e.uploaded?t.jsx("div",{className:"w-5 h-5 bg-green-500 rounded-full flex items-center justify-center",children:t.jsx(M,{className:"w-3 h-3 text-white"})}):t.jsx(ke,{className:"w-5 h-5 text-gray-400"})}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-sm font-normal overflow-hidden w-32 whitespace-nowrap cursor-pointer text-ellipsis text-gray-900",title:e.file.name,children:e.file.name}),t.jsxs("div",{className:"text-xs text-gray-500",children:[e.file.date?B(e.file.date).format("DD MMM YYYY"):null," ","|"," ",(e.file.rawSize/(1024*1024)).toFixed(2)," ","MB"]})]}),!e.uploading&&t.jsx("button",{onClick:()=>A(e.id,null),className:"ml-3 w-5 h-5 text-gray-400 hover:text-gray-600 flex-shrink-0 cursor-pointer",children:t.jsx(Y,{className:"w-5 h-5"})})]}):t.jsxs("div",{className:"relative",children:[t.jsx("input",{type:"file",className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10",onChange:s=>A(e.id,s.target.files?.[0]||null),accept:".pdf,.jpg,.jpeg,.png"}),t.jsxs("div",{className:"flex items-center justify-center px-3 py-3 h-[44px] bg-gray-100 cursor-pointer hover:bg-gray-200 border-2 border-dashed border-gray-300",children:[t.jsx(Ce,{className:"w-3 h-3 mr-2 text-gray-400"}),t.jsx("span",{className:"text-sm text-gray-600 font-normal",children:"Click to Upload File"})]})]}),e.fileError&&t.jsx("p",{className:"text-red-500 text-xs mt-1",children:e.fileError})]})]}),t.jsxs("div",{className:"col-span-5 space-y-2",children:[t.jsx("label",{className:k,children:"Select Document Type"}),t.jsxs("div",{className:"relative",ref:D(e.id),children:[t.jsxs("div",{className:"relative",children:[t.jsx("input",{type:"text",placeholder:"Search document type...",value:j[e.id]||ue(e),onChange:s=>oe(e.id,s.target.value),onFocus:()=>le(e.id),className:"w-full pl-2 2xl:px-4 py-3 bg-gray-100 text-sm outline-none pr-24"}),(e.documentType||j[e.id])&&t.jsx("button",{type:"button",onClick:()=>xe(e.id),className:"absolute cursor-pointer inset-y-0 right-16 top-2.5 flex items-center justify-center w-6 h-6 hover:text-red-500",children:t.jsx(Y,{className:"h-4 w-4 text-gray-400 cursor-pointer"})}),t.jsx("div",{className:"absolute inset-y-0 right-8 top-2.5 flex items-center justify-center w-6 h-6 pointer-events-none",children:t.jsx(_e,{className:"h-4 w-4 text-gray-400"})}),t.jsx("button",{type:"button",onClick:()=>ie(e.id),className:"absolute top-0 inset-y-0 right-0 flex items-center justify-center w-8 h-full",children:t.jsx(Ue,{className:`h-4 w-4 text-gray-400 transition-transform ${E[e.id]?"rotate-180":""}`})})]}),E[e.id]&&t.jsx("div",{className:C("absolute z-50 w-full bg-white border border-gray-300 shadow-lg max-h-44 overflow-y-auto",G[e.id]==="top"?"bottom-full mb-1":"top-full mt-1"),children:O(j[e.id]||"").length>0?O(j[e.id]||"").map(s=>t.jsxs("div",{onClick:()=>ae(e.id,s),className:C("flex items-center justify-between px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm",e.documentType===s&&"bg-gray-50"),children:[t.jsx("span",{className:"flex-1",children:s}),e.documentType===s&&t.jsx(M,{className:"h-4 w-4 text-green-600"})]},s)):t.jsx("div",{className:"px-3 py-2 text-sm text-gray-500",children:"No document types found"})}),e.documentType==="Other"&&t.jsx("input",{type:"text",value:e.customType,onChange:s=>ne(e.id,s.target.value),placeholder:"Enter custom document type",className:`${R} mt-2`}),e.documentTypeError&&t.jsx("p",{className:"text-red-500 text-xs mt-1",children:e.documentTypeError})]})]}),t.jsx("div",{className:"col-span-1 flex justify-end pt-6",children:i?.length!==0?t.jsx("button",{onClick:()=>L(e.id),className:"w-11 h-11 cursor-pointer flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-gray-100 rounded-md transition-colors border border-gray-300",disabled:e.uploading,children:t.jsx($,{className:"w-5 h-5"})}):l.length!==1&&t.jsx("button",{onClick:()=>L(e.id),className:"w-11 h-11 cursor-pointer flex items-center justify-center text-gray-400 hover:text-red-500 hover:bg-gray-100 rounded-md transition-colors border border-gray-300",disabled:e.uploading,children:t.jsx($,{className:"w-5 h-5"})})})]},e.id))}),t.jsx("div",{className:"pt-2",children:t.jsxs("button",{onClick:ce,className:C("inline-flex items-center px-4 py-2.5 text-sm font-normal text-gray-700 bg-white border border-gray-300 rounded-none focus:outline-none focus:ring-0 transition-colors cursor-pointer hover:bg-gray-50"),children:[t.jsx(Ie,{className:"w-4 h-4 mr-2 text-gray-600"}),"Add Another Document"]})}),I&&t.jsx("p",{className:"text-red-500 text-xs mt-1",children:I}),t.jsxs("div",{className:"col-span-12 space-y-2 mt-4",children:[t.jsx("label",{className:k,children:"Remarks"}),t.jsx("textarea",{value:_,onChange:e=>T(e.target.value),placeholder:"Enter remarks for the documents",className:`${R} resize-none`,rows:2})]})]}),t.jsxs("div",{className:"flex justify-end mt-3 gap-2",children:[i?.length>0&&!P&&t.jsx("div",{className:"flex justify-end ",children:t.jsx("button",{onClick:()=>{x(!m),o([])},className:"bg-transparent cursor-pointer border rounded-none active:scale-95 duration-300 transition-all  text-black font-medium text-sm 3xl:text-base px-4 py-0 h-8 outline-none focus:outline-none hover:bg-transparent",children:m&&"Cancel"})}),t.jsx("button",{onClick:de,className:"bg-black hover:bg-black  text-white cursor-pointer font-medium active:scale-95 duration-300 transition-all text-sm 3xl:text-base px-4 py-0 h-8 rounded-none focus-visible:ring-0 focus-visible:ring-offset-0 focus-visible:ring-transparent focus:ring-none  outline-none focus:outline-none",disabled:l.some(e=>e.uploading)||z,children:z?t.jsxs("span",{className:"flex items-center",children:[i?.length===0?"Submitting...":"Updating...",t.jsx(V,{className:"animate-spin h-5 w-5 mx-1"})]}):i?.length===0?"Submit":"Update"})]})]})}):t.jsxs("div",{className:"p-2",children:[t.jsx("div",{className:"bg-white overflow-hidden",children:t.jsx("div",{className:"overflow-x-auto max-h-[calc(100vh-380px)]",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"bg-black sticky top-0 z-10",children:t.jsxs("tr",{children:[t.jsx("th",{className:"px-4 py-3 text-left text-xs font-normal text-white/80 uppercase tracking-wider",children:"Date"}),t.jsx("th",{className:"px-4 py-3 text-left text-xs font-normal text-white/80 uppercase tracking-wider",children:"Document Name"}),t.jsx("th",{className:"px-4 py-3 text-left text-xs font-normal text-white/80 uppercase tracking-wider",children:"Type"}),t.jsx("th",{className:"px-4 py-3 text-left text-xs font-normal text-white/80 uppercase tracking-wider",children:"Actions"})]})}),t.jsx("tbody",{children:Array.isArray(i)&&i.map((e,s)=>t.jsxs("tr",{className:`hover:bg-gray-200 ${s%2===0?"bg-gray-100":"bg-white"}`,children:[t.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:B(e.created_at).format("DD MMM YYYY")}),t.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:t.jsx("div",{className:"text-ellipsis whitespace-nowrap w-32 cursor-pointer overflow-hidden",title:e?.file_name,children:e?.file_name||"--"})}),t.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:e.document_type}),t.jsxs("td",{className:"px-4 py-3 text-sm text-gray-900",children:[t.jsx("button",{onClick:()=>pe(e.download_url),className:"p-1 hover:bg-gray-300 rounded cursor-pointer",title:"View Document",children:t.jsx(Fe,{className:"w-4 h-4 text-gray-600"})}),t.jsx("button",{onClick:()=>me(e),disabled:re,className:"p-1 hover:bg-gray-300 rounded transition-colors disabled:opacity-50 cursor-pointer",title:"Download Document",children:X===e.id?t.jsx(V,{className:"w-4 h-4 text-gray-600 animate-spin"}):t.jsx(Pe,{className:"w-4 h-4 text-gray-600"})})]})]},e.id))})]})})}),i?.[0]?.remarks&&t.jsxs("div",{className:"col-span-12 space-y-2 mt-4 flex flex-col p-4 pt-2",children:[t.jsx("div",{className:"w-full text-sm font-normal text-gray-700 mb-1",children:"Remarks"}),t.jsx("div",{className:"bg-gray-50 p-2 max-h-16 overflow-y-auto overflow-x-hidden",children:i[0].remarks})]})]})]})})};function Gt({stage:v,subStage:m}){const[x,p]=c.useState(!1),{isUser:D}=ge(),{allDocsIsFetching:w,allDocsData:l}=H();return c.useEffect(()=>{l?.length===0&&p(!1)},[]),t.jsx("div",{className:"h-full relative",children:w?t.jsx(he,{loading:w,message:"Loading documents..."}):t.jsxs(t.Fragment,{children:[t.jsx(we,{caseStage:v,caseSubStage:m,showActionButton:D()?!1:l?.length!==0&&!x,showNoteButton:!1}),t.jsx("div",{className:"px-2 py-1 sm:px-2",children:t.jsx(ze,{subStage:m,editMode:x,setEditMode:p})})]})})}export{Gt as default};
